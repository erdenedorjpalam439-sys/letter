import React, { useState, useEffect, useRef } from 'react';
import { Heart } from 'lucide-react';

const App = () => {
  const [isCompleted, setIsCompleted] = useState(false);
  const [isSealPopped, setIsSealPopped] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const [showLetter, setShowLetter] = useState(false);
  const [isSettled, setIsSettled] = useState(false);
  const [holdProgress, setHoldProgress] = useState(0);
  const [particles, setParticles] = useState([]);
  
  // Window State
  const [winPos, setWinPos] = useState({ x: 0, y: 0 });
  const [winSize, setWinSize] = useState({ w: 500, h: 650 });
  const [isDragging, setIsDragging] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const dragStart = useRef({ x: 0, y: 0 });
  const sizeStart = useRef({ w: 0, h: 0 });

  const sealStateRef = useRef({ 
    x: 0, y: 0, rotation: 0, vx: 0, vy: 0, torque: 0, 
    holding: false, progress: 0 
  });
  const sealElementRef = useRef(null);
  const physicsRef = useRef();
  const lastTimeRef = useRef(performance.now());

  const paragraphs = [
    `Хамгийн эхлээд хайрт чамаасаа уучлалт хүсье, бас баярласан сэтгэлээ илэрхийлье. Анх 2023 оны өвөл чамайг Хайраа багшийн олимпиадын бэлтгэл дээр харж байлаа, тэр үедээ орос англи хэлэнд аль алинд нь сайн байсан болохоор чинь атаархаж бас өрсөлдөгчөө гэж харж байсан.`,
    `Тэгээд хичээл ороод Хайраа багшийн давтлагад нь туслах багш хийж байхдаа, 9-ийн и-ийн хүүхдүүд гэж мэдээд чамайг суухгүй юм байх даа гэж нэлээд хүсэж хүлээж байсан...`,
    `Дараа нь 10-р анги эхэлж чамайг ангид байгааг мэдээд бага багаар ажиглаж эхэлсэн... Одгэ багшийн хичээл дээр “Чинхүслээн” гээд л багш чамайг дуудаад эссэг чинь магтахад чиний өхөөрдөм үйл хөдлөл чинь нүдэнд тусдаг байлаа...`,
    `Хайр нь болоогүй зүйлсийн тухай бодсоор, бодох бодохдоо харанхуй талаас нь хэт ургуулж бодсоор “одоо”-оо сүйрүүлжээ. Иймээс хайр нь болоогүй ирээдүйд биш зөвхөн чамдаа анхаарч, сэтгэл зүйгээ ч бас тогтвортой байлганаа.`,
    `Би өөрийгөө засаад гэсэн ч гэлээ, алдаагаа, буруу хийсэн зүйлсээ засаж байгаа болохоор, би “би” хэвээрээ л байх болохоор чамд минь санаа зовох зүйл байхгүй ээ.`
  ];

  const startDrag = (e) => {
    if (!isSettled) return;
    setIsDragging(true);
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    dragStart.current = { x: clientX - winPos.x, y: clientY - winPos.y };
  };

  const startResize = (e) => {
    e.stopPropagation();
    setIsResizing(true);
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    sizeStart.current = { x: clientX, y: clientY, w: winSize.w, h: winSize.h };
  };

  useEffect(() => {
    const handleMove = (e) => {
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      if (isDragging) {
        setWinPos({ x: clientX - dragStart.current.x, y: clientY - dragStart.current.y });
      }
      if (isResizing) {
        const newW = Math.max(320, sizeStart.current.w + (clientX - sizeStart.current.x));
        const newH = Math.max(400, sizeStart.current.h + (clientY - sizeStart.current.y));
        setWinSize({ w: newW, h: newH });
      }
    };
    const handleEnd = () => {
      setIsDragging(false);
      setIsResizing(false);
    };

    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchmove', handleMove);
    window.addEventListener('touchend', handleEnd);
    return () => {
      window.removeEventListener('mousemove', handleMove);
      window.removeEventListener('mouseup', handleEnd);
      window.removeEventListener('touchmove', handleMove);
      window.removeEventListener('touchend', handleEnd);
    };
  }, [isDragging, isResizing]);

  const triggerBurst = () => {
    const burst = [];
    for (let i = 0; i < 35; i++) {
      const angle = (i / 35) * Math.PI * 2;
      const speed = 3 + Math.random() * 6;
      burst.push({
        id: Math.random(), x: window.innerWidth / 2, y: window.innerHeight / 2,
        vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
        size: 2 + Math.random() * 4, color: i % 2 === 0 ? '#f472b6' : '#db2777',
        life: 1.5,
      });
    }
    setParticles(prev => [...prev, ...burst]);
  };

  const loop = (time) => {
    const deltaTime = time - lastTimeRef.current;
    lastTimeRef.current = time;
    const state = sealStateRef.current;

    if (state.holding && !isCompleted) {
      state.progress = Math.min(100, state.progress + (deltaTime * 0.09));
      setHoldProgress(state.progress);
      if (state.progress >= 100) {
        setIsCompleted(true);
        triggerBurst();
        setTimeout(() => {
          setIsSealPopped(true);
          state.vx = (Math.random() - 0.5) * 15;
          state.vy = -25;
          state.torque = (Math.random() - 0.5) * 40;
        }, 200);
      }
    } else if (!isCompleted) {
      state.progress = Math.max(0, state.progress - (deltaTime * 0.2));
      setHoldProgress(state.progress);
    }

    if (isSealPopped && sealElementRef.current) {
      state.vy += 0.8;
      state.vx *= 0.98;
      state.torque *= 0.98;
      state.x += state.vx;
      state.y += state.vy;
      state.rotation += state.torque;
      sealElementRef.current.style.transform = `translate3d(calc(-50% + ${state.x}px), calc(-50% + ${state.y}px), 0) rotate(${state.rotation}deg)`;
      if (!isOpen && state.y > 300) setIsOpen(true);
    }

    setParticles(prev => 
      prev.map(p => ({
        ...p, x: p.x + p.vx, y: p.y + p.vy,
        life: p.life - 0.015,
      })).filter(p => p.life > 0)
    );
    physicsRef.current = requestAnimationFrame(loop);
  };

  useEffect(() => {
    physicsRef.current = requestAnimationFrame(loop);
    return () => cancelAnimationFrame(physicsRef.current);
  }, [isCompleted, isSealPopped, isOpen]);

  useEffect(() => {
    if (isOpen) {
      setTimeout(() => setShowLetter(true), 500);
      setTimeout(() => setIsSettled(true), 2500);
    }
  }, [isOpen]);

  const radius = 45;
  const circumference = 2 * Math.PI * radius;
  const strokeDashoffset = circumference - (holdProgress / 100) * circumference;

  return (
    <div className="fixed inset-0 bg-[#1c1917] overflow-hidden flex items-center justify-center font-serif select-none">
      <style>{`
        .paper-texture { background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'); }
        @keyframes softWiggle { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(0.6deg); } 75% { transform: rotate(-0.6deg); } }
        .animate-soft-wiggle { animation: softWiggle 3s ease-in-out infinite; }
      `}</style>

      {/* Background Particles */}
      <div className="fixed inset-0 pointer-events-none z-[200]">
        {particles.map(p => (
          <div key={p.id} className="absolute rounded-full" style={{
            width: `${p.size}px`, height: `${p.size}px`, left: `${p.x}px`, top: `${p.y}px`,
            backgroundColor: p.color, opacity: p.life, transform: `translate(-50%, -50%) scale(${p.life})`,
            boxShadow: `0 0 ${p.size * 2}px ${p.color}`
          }} />
        ))}
      </div>

      {/* Envelope Section */}
      {!isSettled && (
        <div className={`relative w-[300px] sm:w-[460px] h-[220px] sm:h-[320px] transition-all duration-1000 z-30 flex items-center justify-center
            ${!isSealPopped ? 'animate-soft-wiggle' : ''}
            ${isOpen ? 'translate-y-[250px] scale-[0.45] opacity-50' : 'scale-100'}`}>
          
          <div className="absolute inset-0 bg-gradient-to-br from-[#8b1e1e] to-[#630a0a] rounded shadow-2xl border border-[#4a0d18] z-20">
            <div className="absolute inset-0 opacity-15 pointer-events-none mix-blend-overlay" style={{ backgroundImage: `url('https://www.transparenttextures.com/patterns/paper-fibers.png')` }} />
            <div className="absolute inset-0 bg-[#7a1515] z-10" style={{ clipPath: 'polygon(0% 0%, 50% 55%, 100% 0%, 100% 100%, 0% 100%)' }} />
            <div className="absolute top-0 w-full h-[60%] bg-[#9c2525] border-b border-black/20 transition-transform duration-[1.2s] ease-in-out" 
                style={{ clipPath: 'polygon(0% 0%, 100% 0%, 50% 100%)', transform: isOpen ? 'rotateX(180deg)' : 'rotateX(0deg)', zIndex: isOpen ? 5 : 40, transformOrigin: 'top' }}>
                <div className={`absolute inset-0 bg-[#8b1e1e] transition-opacity duration-1000 ${isOpen ? 'opacity-100' : 'opacity-0'}`} />
            </div>
          </div>

          {/* Restored Wax Seal */}
          <div 
            ref={sealElementRef}
            onMouseDown={() => { sealStateRef.current.holding = true; }}
            onMouseUp={() => { sealStateRef.current.holding = false; }}
            onTouchStart={() => { sealStateRef.current.holding = true; }}
            onTouchEnd={() => { sealStateRef.current.holding = false; }}
            className={`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-[110] transition-transform duration-500
                ${!isSealPopped ? 'scale-100 cursor-pointer hover:scale-110' : 'pointer-events-none'}`}
          >
            <div className="relative w-28 sm:w-32 h-28 sm:h-32 flex items-center justify-center">
              {holdProgress > 0 && !isCompleted && (
                <svg className="absolute inset-0 w-full h-full -rotate-90 z-50 overflow-visible pointer-events-none scale-110">
                  <circle cx="50%" cy="50%" r={radius} fill="transparent" stroke="rgba(255, 183, 197, 0.2)" strokeWidth="4" />
                  <circle cx="50%" cy="50%" r={radius} fill="transparent" stroke="#ffb7c5" strokeWidth="4" strokeDasharray={circumference}
                    style={{ strokeDashoffset, transition: 'stroke-dashoffset 0.1s linear' }} strokeLinecap="round" />
                </svg>
              )}
              <div className="relative w-20 sm:w-24 h-20 sm:h-24 flex items-center justify-center">
                <div className="absolute inset-0 bg-gradient-to-br from-[#ffb7c5] to-[#ff66a3] rounded-[45%_55%_50%_48%] rotate-[20deg] shadow-2xl" />
                <div className="relative z-10 w-16 sm:w-20 h-16 sm:h-20 rounded-full flex items-center justify-center" style={{ background: 'radial-gradient(circle at 40% 40%, #ff85b3 0%, #db2777 100%)', boxShadow: 'inset 4px 4px 12px rgba(0,0,0,0.4)' }}>
                  <Heart fill="#701a41" className="w-8 sm:w-10 h-8 sm:h-10 text-[#701a41] opacity-70" />
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Draggable Letter Window */}
      {showLetter && (
        <div 
          className={`fixed bg-[#fdfcf9] paper-texture shadow-2xl overflow-hidden flex flex-col transition-all duration-700
            ${!isSettled ? 'left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[400px] z-[5] opacity-50' : 'z-[300] border border-stone-300 rounded-lg'}
          `}
          style={isSettled ? {
            left: `calc(50% + ${winPos.x}px)`,
            top: `calc(50% + ${winPos.y}px)`,
            width: `${winSize.w}px`,
            height: `${winSize.h}px`,
            transform: 'translate(-50%, -50%)',
            transition: isDragging || isResizing ? 'none' : 'all 0.3s ease-out'
          } : {}}
        >
          {/* Window Bar */}
          <div 
            onMouseDown={startDrag}
            onTouchStart={startDrag}
            className="h-10 bg-stone-200 border-b border-stone-300 flex items-center justify-between px-3 cursor-grab active:cursor-grabbing shrink-0"
          >
            <div className="flex items-center gap-2 text-stone-600">
              <Heart size={14} className="text-pink-500 fill-pink-500" />
              <span className="text-[10px] sm:text-xs font-sans font-bold uppercase tracking-wider">A Message for You.doc</span>
            </div>
            <div className="flex gap-1.5">
              <div className="w-2.5 h-2.5 rounded-full bg-stone-400" />
              <div className="w-2.5 h-2.5 rounded-full bg-stone-400" />
              <div className="w-2.5 h-2.5 rounded-full bg-stone-400" />
            </div>
          </div>

          {/* Letter Body */}
          <div className="flex-1 overflow-y-auto p-6 sm:p-14 relative">
            <div className="max-w-prose mx-auto text-stone-800 leading-relaxed text-base sm:text-lg">
              {paragraphs.map((p, i) => (
                <p key={i} className="mb-6 indent-8 text-justify font-serif italic">
                  {p}
                </p>
              ))}
              <div className="mt-12 text-center border-t border-stone-200 pt-10">
                <p className="mb-6 text-pink-600 font-bold text-xl">Хүслээ, намайг чиний найз залуу болохыг зөвшөөрч байна уу?</p>
                <div className="flex justify-center gap-6 mt-4">
                  <button className="px-8 py-2 bg-pink-500 text-white rounded shadow-md hover:bg-pink-600 transition-all hover:scale-105 active:scale-95">Тийм</button>
                  <button className="px-8 py-2 border border-stone-300 text-stone-500 rounded hover:bg-stone-50 transition-all">Магадгүй</button>
                </div>
              </div>
              <div className="h-10" />
            </div>
          </div>

          {/* Resize Corner */}
          <div 
            onMouseDown={startResize}
            onTouchStart={startResize}
            className="absolute bottom-0 right-0 w-8 h-8 cursor-nwse-resize flex items-end justify-end p-1.5"
          >
            <div className="grid grid-cols-2 gap-0.5 opacity-30">
                <div className="w-1 h-1 bg-stone-600 rounded-full"/>
                <div className="w-1 h-1 bg-stone-600 rounded-full"/>
                <div className="w-1 h-1 bg-stone-600 rounded-full"/>
                <div className="w-1 h-1 bg-stone-600 rounded-full"/>
            </div>
          </div>
        </div>
      )}

      {!isCompleted && (
        <div className="fixed bottom-12 text-stone-500 text-[10px] tracking-[0.4em] uppercase opacity-60">
          Hold seal to unlock
        </div>
      )}
    </div>
  );
};

export default App;
